<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Server-side Events · Treats</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Server-side events can be used for example to send tracking or monitoring metrics, etc. Events can be registered by providing custom server app through &lt;code&gt;_server/index.js&lt;/code&gt; filesystem hooks. Here&#x27;s an example of tracking default render events with [datadog][datadog-website].&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Server-side Events · Treats"/><meta property="og:type" content="website"/><meta property="og:url" content="https://tokopedia.github.io/treats/treats/index.html"/><meta property="og:description" content="&lt;p&gt;Server-side events can be used for example to send tracking or monitoring metrics, etc. Events can be registered by providing custom server app through &lt;code&gt;_server/index.js&lt;/code&gt; filesystem hooks. Here&#x27;s an example of tracking default render events with [datadog][datadog-website].&lt;/p&gt;
"/><meta property="og:image" content="https://tokopedia.github.io/treats/treats/img/toped.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://tokopedia.github.io/treats/treats/img/toped.png"/><link rel="shortcut icon" href="/treats/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/treats/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/treats/"><img class="logo" src="/treats/img/treats.png" alt="Treats"/><h2 class="headerTitleWithLogo">Treats</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/treats/docs/installation.html" target="_self">Getting Started</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Main Concepts</span></h2></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/installation.html">Installation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Tutorial</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/tutorial/00.html">00. Tutorial is Coming Soon</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Main Concepts</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/routing.html">Routing</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/localization.html">Localization</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/code-splitting.html">Code-splitting</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/redux.html">Redux</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/graphql-client.html">GraphQL Client</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/middleware.html">Middlewares</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/helper.html">Helpers</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/treats/docs/main-concept/server-side-event.html">Server-side Events</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/server-side-template.html">Server-side Template</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/server-side-rendering.html">Server-side Rendering</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/custom-server-app.html">Custom Server App</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/custom-client-initialization.html">Custom Client Initialization</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/custom-react-app.html">Custom React App</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/runtime-config.html">Runtime Config</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/build-config.html">Build Config</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/environment-variable.html">Environment Variables</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/generator.html">Code Generator</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/scripts.html">Scripts</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/main-concept/addons.html">Addons</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API Reference</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/filesystem-hooks.html">Filesystem Hooks</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/component.html">Components</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/server.html">Server</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/client.html">Client</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/router.html">Router</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/intl.html">Intl</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/locale-data.html">Locale Data</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/helmet.html">Helmet</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/redux.html">Redux</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/api-reference/graphql.html">Graphql</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Authoring Addons</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/authoring-addons/overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/authoring-addons/helper.html">Helpers</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/authoring-addons/middleware.html">Middlewares</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/authoring-addons/generator.html">Generators</a></li><li class="navListItem"><a class="navItem" href="/treats/docs/authoring-addons/wrap-up.html">Wrapping Up</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Addons</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/list-of-addons.html">Treats Addons List</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Contributing</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/contributing/how-to-contribute.html">How To Contribute</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">FAQ</h3><ul><li class="navListItem"><a class="navItem" href="/treats/docs/faq.html">FAQs</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Server-side Events</h1></header><article><div><span><p>Server-side events can be used for example to send tracking or monitoring metrics, etc. Events can be registered by providing custom server app through <code>_server/index.js</code> filesystem hooks. Here's an example of tracking default render events with <a href="https://www.datadoghq.com/">datadog</a>.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">import</span> initServer, { EVENT_TYPES } <span class="hljs-keyword">from</span> <span class="hljs-string">"@treats/server"</span>;
<span class="hljs-keyword">import</span> datadogHelper <span class="hljs-keyword">from</span> <span class="hljs-string">"@treats/addons-base/helper/datadog"</span>;

<span class="hljs-keyword">const</span> app = initServer({
    <span class="hljs-comment">// register datadog helpers t be used later on</span>
    customHelpers: datadogHelper,
    <span class="hljs-comment">// register custom events</span>
    customEvents: {
        [EVENT_TYPES.BEFORE_RENDER]: <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
            req.ddogTimer = {
                <span class="hljs-attr">beforeRender</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()
            };
        },
        [EVENT_TYPES.AFTER_RENDER]: <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
            req.ddogTimer.afterRender = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();

            <span class="hljs-keyword">const</span> { app } = req,
                ddogClient = app.get(<span class="hljs-string">"datadog"</span>),
                renderTime = req.ddogTimer.afterRender - req.ddogTimer.beforeRender;

            ddogClient.histogram(<span class="hljs-string">"process_time"</span>, renderTime, [<span class="hljs-string">`mylabel`</span>]);
        },
        [EVENT_TYPES.ERROR_RENDER]: <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> { app } = req,
                ddogClient = app.get(<span class="hljs-string">"datadog"</span>);

            ddogClient.increment(<span class="hljs-string">"error_count"</span>);
        }
    }
})
</code></pre>
<p>By default, Treats provided several events that can be imported from <code>@treats/server</code>:</p>
<ol>
<li><code>BEFORE_RENDER</code> - Events that would be triggered before React rendering happens.</li>
<li><code>AFTER_RENDER</code> - Events that would be triggered after React rendering success and markup is ready to be sent.</li>
<li><code>ERROR_RENDER</code> - Events that would be triggered when React rendering errors occured.</li>
<li><code>LOCALE_MIDDLEWARE@no_locale</code> - Events that would be called when locale middleware found no existing locale from cookie and didn't find <code>lang</code> in query string either.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="providing-custom-event-hooks"></a><a href="#providing-custom-event-hooks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Providing Custom Event hooks</h2>
<p>Middlewares or helpers can provides their own custom event hooks. Users can then register their events by declaring it on custom server app. Below are example of how this interaction might happens:</p>
<pre><code class="hljs css language-js"><span class="hljs-comment">// @treats/addons-example/middleware/example/index.js</span>
<span class="hljs-keyword">const</span> exampleMiddleware = {
    middleware(req, res, next) {
        <span class="hljs-comment">// get event manager from app</span>
        <span class="hljs-keyword">const</span> { app } = req,
        eventManager = app.get(<span class="hljs-string">"eventManager"</span>);

        <span class="hljs-comment">// trigger event via event manager        </span>
        eventManager.fire(<span class="hljs-string">"example_event"</span>, req, res, optional_params1, optional_params2);
        ...

        <span class="hljs-comment">// calling middleware's next function so it would move on to next middleware</span>
        next();
    }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> exampleMiddleware;
</code></pre>
<p>In your custom server app:</p>
<pre><code class="hljs css language-js"><span class="hljs-comment">// src/_server/index.js</span>
<span class="hljs-keyword">import</span> initServer <span class="hljs-keyword">from</span> <span class="hljs-string">"@treats/server"</span>;
<span class="hljs-keyword">import</span> exampleMiddleware <span class="hljs-keyword">from</span> <span class="hljs-string">"@treats/addons-example/middleware/example"</span>;

<span class="hljs-keyword">const</span> app = initServer({
    <span class="hljs-comment">// register the middleware</span>
    customMiddleware: exampleMiddleware,
    <span class="hljs-comment">// provides custom event for the middleware</span>
    customEvents: {
        <span class="hljs-string">"example_event"</span>: <span class="hljs-function">(<span class="hljs-params">req, res, additional_param1, additional_param2</span>) =&gt;</span> {
            <span class="hljs-comment">// do things with the event</span>
            ....
        }
    }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> app;
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/treats/docs/main-concept/helper.html"><span class="arrow-prev">← </span><span>Helpers</span></a><a class="docs-next button" href="/treats/docs/main-concept/server-side-template.html"><span>Server-side Template</span><span class="arrow-next"> →</span></a></div></div></div></div><footer class="nav-footer" id="footer"><a href="https://github.com/tokopedia/" target="_blank" rel="noreferrer noopener" class="tkpdOpensource"><img class="tkpdOpenSourceLogo" src="/treats/img/tokopedia.png" alt="Tokopedia Open Source"/></a><section class="copyright">Copyright © 2018 Tokopedia OSS</section></footer></div></body></html>